# Implementation Plan: Backend AI + MCP Integration

**Branch**: `main` | **Date**: 2026-02-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/backend-ai-mcp/spec.md`

## Summary

Extend Phase II CRUD backend with conversational AI layer using OpenAI Agents SDK and Model Context Protocol (MCP). Implement stateless FastAPI chat endpoint with Master Agent orchestrating Task, Conversation, and Confirmation sub-agents. All MCP tools delegate to existing TaskService; new ConversationService manages chat persistence in PostgreSQL. No frontend or auth modifications.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI 0.104+, OpenAI SDK 1.0+, Official MCP SDK 1.0+, SQLModel 0.0.14+
**Storage**: PostgreSQL (Neon Serverless) / SQLite (dev)
**Testing**: pytest with fixtures from Phase II
**Target Platform**: Linux server (Vercel deployment target)
**Project Type**: Web (backend-only modification)
**Performance Goals**: P95 < 3s per chat request (includes OpenAI latency)
**Constraints**: Stateless design (no agent state persists), reuse Phase II models/services unchanged
**Scale/Scope**: Single-user chat sessions, 20-message context window, 5 MCP tools

## Constitution Check

✅ **AI-First Architecture**: Chat endpoint provides natural language interface
✅ **MCP-Driven Operations**: All task operations via standardized MCP tools
✅ **Stateless Design**: Agent instantiated/discarded per request, DB-loaded context
✅ **Sub-Agent Orchestration**: Master → Task/Conversation/Confirmation agents
✅ **Conversation Context Preservation**: Conversation/Message models in PostgreSQL
✅ **Reusable Intelligence**: TaskService unchanged, new ConversationService follows pattern

**Violations**: None

## Project Structure

### Documentation (this feature)

```text
specs/backend-ai-mcp/
├── spec.md              # Feature specification (already created)
├── plan.md              # This file
└── tasks.md             # Generated by /sp.tasks (next step)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── task.py              # [REUSED] Phase II
│   │   ├── user.py              # [REUSED] Phase II
│   │   ├── refresh_token.py     # [REUSED] Phase II
│   │   ├── conversation.py      # [NEW] Phase III
│   │   ├── message.py           # [NEW] Phase III
│   │   └── __init__.py          # [MODIFIED] Import new models
│   ├── services/
│   │   ├── task_service.py      # [REUSED] Phase II
│   │   ├── auth_service.py      # [REUSED] Phase II
│   │   └── conversation_service.py  # [NEW] Phase III
│   ├── schemas/
│   │   ├── task_schemas.py      # [REUSED] Phase II
│   │   ├── auth_schemas.py      # [REUSED] Phase II
│   │   └── chat_schemas.py      # [NEW] Phase III
│   ├── mcp/
│   │   ├── __init__.py          # [NEW] Phase III
│   │   ├── server.py            # [NEW] MCP server + tool definitions
│   │   └── context.py           # [NEW] Context management (user_id injection)
│   ├── agents/
│   │   ├── __init__.py          # [NEW] Phase III
│   │   ├── master_agent.py      # [NEW] Master orchestrator
│   │   ├── task_agent.py        # [NEW] Task sub-agent
│   │   ├── conversation_agent.py # [NEW] Conversation sub-agent
│   │   └── confirmation_agent.py # [NEW] Confirmation sub-agent
│   ├── api/
│   │   └── routes/
│   │       ├── tasks.py         # [REUSED] Phase II
│   │       ├── auth.py          # [REUSED] Phase II
│   │       └── chat.py          # [NEW] Phase III chat endpoints
│   ├── database.py              # [MODIFIED] Import new models
│   └── main.py                  # [MODIFIED] Register chat router
└── tests/
    ├── unit/
    │   ├── test_task_service.py  # [REUSED] Phase II
    │   ├── test_conversation_service.py  # [NEW] Phase III
    │   └── test_mcp_tools.py     # [NEW] Phase III
    ├── integration/
    │   └── test_chat_e2e.py      # [NEW] Phase III
    └── fixtures/
        ├── task_fixtures.py      # [REUSED] Phase II
        └── conversation_fixtures.py  # [NEW] Phase III
```

**Structure Decision**: Web application (Option 2) with backend-only modifications. Frontend exists from Phase II but is out of scope. All new code isolated in `mcp/`, `agents/`, and `api/routes/chat.py`.

## Complexity Tracking

No constitution violations. Complexity justified by requirements:
- **3 sub-agents**: Mandated by spec for separation of concerns (task ops, history, confirmations)
- **MCP layer**: Required by constitution for standardized tool interface
- **Conversation models**: Required for stateless design (persistent context)

---

## Implementation Phases

### Phase 0: Preparation & Dependencies

**Goal**: Install dependencies, verify Phase II baseline, prepare environment

**Tasks**:

1. **Update requirements.txt**
   - Add `openai>=1.0.0` and `mcp>=1.0.0`
   - Run `pip install -r requirements.txt`
   - Verify no conflicts with existing FastAPI/SQLModel
   - **Files**: `backend/requirements.txt`
   - **Dependencies**: None

2. **Add environment variables**
   - Add `OPENAI_API_KEY` to `.env.example` and `.env`
   - Document in README or setup guide
   - **Files**: `.env`, `.env.example`
   - **Dependencies**: Task 1

3. **Verify Phase II baseline**
   - Run existing Phase II tests (`pytest backend/tests`)
   - Confirm TaskService CRUD operations work
   - Confirm auth endpoints return 200/401 correctly
   - **Files**: None (verification only)
   - **Dependencies**: Task 1

---

### Phase 1: Database Models & Schema

**Goal**: Add Conversation and Message models, update DB schema

**Tasks**:

4. **Create Conversation model**
   - File: `backend/src/models/conversation.py`
   - Fields: `id (UUID), user_id (str, indexed), title (Optional[str]), created_at, updated_at`
   - Add docstring matching Task model style
   - **Files**: `backend/src/models/conversation.py`
   - **Dependencies**: Task 3

5. **Create Message model**
   - File: `backend/src/models/message.py`
   - Fields: `id (UUID), conversation_id (FK), role (str), content (str), metadata (JSON), created_at`
   - Add composite index `idx_messages_conversation` on `(conversation_id, created_at)`
   - **Files**: `backend/src/models/message.py`
   - **Dependencies**: Task 4

6. **Update models __init__.py**
   - Import Conversation and Message
   - Export in `__all__` list
   - **Files**: `backend/src/models/__init__.py`
   - **Dependencies**: Task 5

7. **Update database.py**
   - Import Conversation and Message in import statement (line 4)
   - No other changes (auto-detected by SQLModel)
   - **Files**: `backend/src/database.py`
   - **Dependencies**: Task 6

8. **Run database migration**
   - Execute `SQLModel.metadata.create_all(engine)` via startup
   - Or use Alembic: `alembic revision --autogenerate -m "Add Conversation and Message models"`
   - Then: `alembic upgrade head`
   - Verify tables exist in DB
   - **Files**: Database schema
   - **Dependencies**: Task 7

---

### Phase 2: ConversationService

**Goal**: Implement service layer for conversation/message CRUD with user ownership enforcement

**Tasks**:

9. **Create ConversationService class**
   - File: `backend/src/services/conversation_service.py`
   - Constructor: `__init__(self, db: Session, user_id: str)`
   - Follow TaskService pattern exactly
   - **Files**: `backend/src/services/conversation_service.py`
   - **Dependencies**: Task 8

10. **Implement create_conversation**
    - Method: `create_conversation(self, title: Optional[str] = None) -> Conversation`
    - Create conversation with user_id, auto-generate title if None
    - Persist to DB, return Conversation
    - **Files**: `backend/src/services/conversation_service.py` (method)
    - **Dependencies**: Task 9

11. **Implement get_conversation**
    - Method: `get_conversation(self, conversation_id: UUID) -> Conversation`
    - Filter by user_id (enforce ownership)
    - Raise `UnauthorizedAccessError` for cross-user access
    - Raise `ConversationNotFoundError` if not exists
    - **Files**: `backend/src/services/conversation_service.py` (method)
    - **Dependencies**: Task 10

12. **Implement list_conversations**
    - Method: `list_conversations(self, limit: int = 50) -> List[Conversation]`
    - Filter by user_id, order by updated_at desc
    - Return last N conversations
    - **Files**: `backend/src/services/conversation_service.py` (method)
    - **Dependencies**: Task 11

13. **Implement add_message**
    - Method: `add_message(self, conversation_id: UUID, role: str, content: str, metadata: dict = {}) -> Message`
    - Validate conversation ownership (call get_conversation)
    - Create message with timestamp
    - Update conversation.updated_at
    - **Files**: `backend/src/services/conversation_service.py` (method)
    - **Dependencies**: Task 12

14. **Implement get_messages**
    - Method: `get_messages(self, conversation_id: UUID) -> List[Message]`
    - Validate ownership
    - Return messages ordered by created_at asc
    - **Files**: `backend/src/services/conversation_service.py` (method)
    - **Dependencies**: Task 13

15. **Implement delete_conversation**
    - Method: `delete_conversation(self, conversation_id: UUID) -> None`
    - Validate ownership
    - Delete conversation (cascade deletes messages via FK)
    - **Files**: `backend/src/services/conversation_service.py` (method)
    - **Dependencies**: Task 14

16. **Add custom exceptions**
    - Add `ConversationNotFoundError` to `backend/src/utils/errors.py`
    - Follow existing error pattern (TaskNotFoundError)
    - **Files**: `backend/src/utils/errors.py`
    - **Dependencies**: Task 9

---

### Phase 3: MCP Server & Tools

**Goal**: Implement MCP server with 5 task tools delegating to TaskService

**Tasks**:

17. **Create MCP context manager**
    - File: `backend/src/mcp/context.py`
    - Implement `get_context_user_id()` → reads from environment or request context
    - Implement `get_db_session()` → returns DB session
    - **Files**: `backend/src/mcp/context.py`
    - **Dependencies**: Task 16

18. **Initialize MCP server**
    - File: `backend/src/mcp/server.py`
    - Import: `from mcp.server import Server` and `from mcp.server.stdio import stdio_server`
    - Create server: `app = Server("task-management-mcp")`
    - Stub `async def main()` with stdio_server setup
    - **Files**: `backend/src/mcp/server.py`
    - **Dependencies**: Task 17

19. **Implement add_task tool**
    - Decorator: `@app.tool()`
    - Signature: `async def add_task(title: str, description: str = "", priority: str = "medium", tags: list[str] = []) -> dict`
    - Get user_id from context, instantiate TaskService
    - Call `service.create_task(TaskCreate(...))`
    - Return: `{"success": True, "task_id": str(task.id), "message": "..."}`
    - Handle errors: return `{"success": False, "error": str(e)}`
    - **Files**: `backend/src/mcp/server.py` (tool)
    - **Dependencies**: Task 18

20. **Implement list_tasks tool**
    - Signature: `async def list_tasks(status: str = None, priority: str = None, tags: list[str] = None, sort_by: str = None) -> dict`
    - Call `service.list_tasks(...)`
    - Return: `{"success": True, "tasks": [task.dict() for task in tasks], "count": len(tasks)}`
    - **Files**: `backend/src/mcp/server.py` (tool)
    - **Dependencies**: Task 19

21. **Implement complete_task tool**
    - Signature: `async def complete_task(task_id: str) -> dict`
    - Call `service.update_task(UUID(task_id), TaskUpdate(status="completed"))`
    - Return: `{"success": True, "task": task.dict()}`
    - **Files**: `backend/src/mcp/server.py` (tool)
    - **Dependencies**: Task 20

22. **Implement update_task tool**
    - Signature: `async def update_task(task_id: str, title: str = None, description: str = None, status: str = None, priority: str = None, tags: list[str] = None) -> dict`
    - Build TaskUpdate from non-None params
    - Call `service.update_task(UUID(task_id), update_data)`
    - Return: `{"success": True, "task": task.dict()}`
    - **Files**: `backend/src/mcp/server.py` (tool)
    - **Dependencies**: Task 21

23. **Implement delete_task tool**
    - Signature: `async def delete_task(task_id: str) -> dict`
    - Call `service.delete_task(UUID(task_id))`
    - Return: `{"success": True, "message": "Task deleted"}`
    - Note: Confirmation handled by agent layer, not MCP
    - **Files**: `backend/src/mcp/server.py` (tool)
    - **Dependencies**: Task 22

24. **Complete MCP main() function**
    - Implement: `async with stdio_server() as (read_stream, write_stream):`
    - Call: `await app.run(read_stream, write_stream, app.create_initialization_options())`
    - Add `if __name__ == "__main__": asyncio.run(main())`
    - **Files**: `backend/src/mcp/server.py` (main)
    - **Dependencies**: Task 23

---

### Phase 4: OpenAI Agents SDK Integration

**Goal**: Implement Master Agent with MCP client and sub-agents

**Tasks**:

25. **Create Confirmation Sub-Agent**
    - File: `backend/src/agents/confirmation_agent.py`
    - Class: `ConfirmationSubAgent`
    - Constant: `REQUIRES_CONFIRMATION = ["delete_task", "delete_conversation"]`
    - Method: `check_required(tool_name: str) -> bool`
    - Method: `async request_confirmation(tool_name: str, params: dict) -> dict`
    - Method: `async execute_confirmed(action: str, params: dict) -> dict`
    - **Files**: `backend/src/agents/confirmation_agent.py`
    - **Dependencies**: Task 24

26. **Create Task Sub-Agent**
    - File: `backend/src/agents/task_agent.py`
    - Class: `TaskSubAgent`
    - Constructor: `__init__(self, master_agent)`
    - Method: `async handle(intent: str, params: dict) -> dict`
    - Intent mapping: `{"create": "add_task", "list": "list_tasks", ...}`
    - Delegates to `master.mcp_session.call_tool(...)`
    - **Files**: `backend/src/agents/task_agent.py`
    - **Dependencies**: Task 25

27. **Create Conversation Sub-Agent**
    - File: `backend/src/agents/conversation_agent.py`
    - Class: `ConversationSubAgent`
    - Constructor: `__init__(self, master_agent)`
    - Method: `async handle(query: str) -> dict`
    - Loads history via `master._load_history()`
    - Simple filtering (no semantic search for Phase III)
    - **Files**: `backend/src/agents/conversation_agent.py`
    - **Dependencies**: Task 26

28. **Create Master Agent (part 1: initialization)**
    - File: `backend/src/agents/master_agent.py`
    - Class: `MasterAgent`
    - Constructor: `__init__(self, user_id: str, conversation_id: Optional[UUID] = None)`
    - Fields: `self.user_id, self.conversation_id, self.client = OpenAI(), self.mcp_session = None`
    - Instantiate sub-agents: `self.task_agent = TaskSubAgent(self)`, etc.
    - **Files**: `backend/src/agents/master_agent.py` (class + __init__)
    - **Dependencies**: Task 27

29. **Implement Master Agent: connect_mcp()**
    - Method: `async connect_mcp()`
    - Create `StdioServerParameters` with command="python", args=["backend/src/mcp/server.py"]
    - Add env: `{"USER_ID": self.user_id}`
    - Call: `self.mcp_session = await stdio_client(server_params).__aenter__()`
    - List tools: `self.tools = await self.mcp_session.list_tools()`
    - **Files**: `backend/src/agents/master_agent.py` (method)
    - **Dependencies**: Task 28

30. **Implement Master Agent: _load_history()**
    - Method: `_load_history() -> List[dict]`
    - Return empty list if no conversation_id
    - Get DB session, instantiate ConversationService
    - Call `service.get_messages(self.conversation_id)`
    - Limit to last 20 messages (slice `[-20:]`)
    - Return: `[{"role": msg.role, "content": msg.content} for msg in messages]`
    - **Files**: `backend/src/agents/master_agent.py` (method)
    - **Dependencies**: Task 29

31. **Implement Master Agent: _format_mcp_tools()**
    - Method: `_format_mcp_tools(self, tools) -> List[dict]`
    - Convert MCP tool definitions to OpenAI function calling format
    - Map tool schemas to `{"type": "function", "function": {"name": ..., "parameters": ...}}`
    - **Files**: `backend/src/agents/master_agent.py` (method)
    - **Dependencies**: Task 30

32. **Implement Master Agent: _execute_tools()**
    - Method: `async _execute_tools(self, tool_calls) -> List[dict]`
    - Loop through tool_calls
    - For each: `result = await self.mcp_session.call_tool(call.function.name, json.loads(call.function.arguments))`
    - Check if confirmation required via `self.confirmation_agent.check_required(call.function.name)`
    - If required, return confirmation response instead of executing
    - Append results
    - **Files**: `backend/src/agents/master_agent.py` (method)
    - **Dependencies**: Task 31

33. **Implement Master Agent: _check_confirmation_needed()**
    - Method: `_check_confirmation_needed(self, response) -> bool`
    - Check if response contains confirmation metadata
    - Return True if any tool call requires confirmation
    - **Files**: `backend/src/agents/master_agent.py` (method)
    - **Dependencies**: Task 32

34. **Implement Master Agent: process_message()**
    - Method: `async process_message(self, user_message: str) -> dict`
    - Load history: `history = self._load_history()`
    - Build messages: `messages = history + [{"role": "user", "content": user_message}]`
    - Call OpenAI: `response = self.client.chat.completions.create(model="gpt-4", messages=messages, tools=self._format_mcp_tools(self.tools))`
    - If tool_calls: execute via `_execute_tools()`
    - If tool_calls: continue conversation with tool results (second OpenAI call)
    - Return: `{"message": response.choices[0].message.content, "conversation_id": str(self.conversation_id), "requires_confirmation": self._check_confirmation_needed(response)}`
    - **Files**: `backend/src/agents/master_agent.py` (method)
    - **Dependencies**: Task 33

---

### Phase 5: FastAPI Chat Endpoints

**Goal**: Implement stateless HTTP chat interface

**Tasks**:

35. **Create chat schemas**
    - File: `backend/src/schemas/chat_schemas.py`
    - `ChatRequest(BaseModel)`: `message: str, conversation_id: Optional[str], confirm_action: Optional[dict]`
    - `ChatResponse(BaseModel)`: `message: str, conversation_id: str, requires_confirmation: bool, confirmation_details: Optional[dict]`
    - `ConversationResponse(BaseModel)`: `id: str, title: str, created_at: datetime, updated_at: datetime`
    - `MessageResponse(BaseModel)`: `id: str, role: str, content: str, created_at: datetime`
    - **Files**: `backend/src/schemas/chat_schemas.py`
    - **Dependencies**: Task 34

36. **Create chat router**
    - File: `backend/src/api/routes/chat.py`
    - Import: `APIRouter, Depends, get_current_user, MasterAgent, ChatRequest, ChatResponse`
    - Create: `router = APIRouter(prefix="/chat", tags=["chat"])`
    - **Files**: `backend/src/api/routes/chat.py`
    - **Dependencies**: Task 35

37. **Implement POST /chat endpoint (part 1: confirmation handling)**
    - Signature: `async def chat(request: ChatRequest, user: dict = Depends(get_current_user)) -> ChatResponse`
    - Extract: `user_id = user["user_id"]`
    - If `request.confirm_action` exists:
      - Instantiate MasterAgent with conversation_id
      - Call `agent.connect_mcp()`
      - Execute: `result = await agent.confirmation_agent.execute_confirmed(request.confirm_action["action"], request.confirm_action["params"])`
      - Return ChatResponse with result
    - **Files**: `backend/src/api/routes/chat.py` (endpoint, confirmation branch)
    - **Dependencies**: Task 36

38. **Implement POST /chat endpoint (part 2: normal message processing)**
    - Instantiate MasterAgent: `agent = MasterAgent(user_id, UUID(request.conversation_id) if request.conversation_id else None)`
    - Connect MCP: `await agent.connect_mcp()`
    - Process: `response = await agent.process_message(request.message)`
    - **Files**: `backend/src/api/routes/chat.py` (endpoint, normal branch)
    - **Dependencies**: Task 37

39. **Implement POST /chat endpoint (part 3: persistence)**
    - Get DB session: `db = next(get_db())`
    - Instantiate ConversationService: `conv_service = ConversationService(db, user_id)`
    - If no conversation_id: create new conversation
    - Save user message: `conv_service.add_message(conversation_id, "user", request.message)`
    - Save assistant response: `conv_service.add_message(conversation_id, "assistant", response["message"])`
    - Return ChatResponse
    - **Files**: `backend/src/api/routes/chat.py` (endpoint, persistence)
    - **Dependencies**: Task 38

40. **Implement GET /conversations**
    - Signature: `async def list_conversations(user: dict = Depends(get_current_user)) -> List[ConversationResponse]`
    - Get DB, instantiate service
    - Call `service.list_conversations()`
    - Return conversations
    - **Files**: `backend/src/api/routes/chat.py` (endpoint)
    - **Dependencies**: Task 39

41. **Implement GET /conversations/{id}/messages**
    - Signature: `async def get_conversation_messages(conversation_id: str, user: dict = Depends(get_current_user)) -> List[MessageResponse]`
    - Get DB, instantiate service
    - Call `service.get_messages(UUID(conversation_id))`
    - Return messages
    - **Files**: `backend/src/api/routes/chat.py` (endpoint)
    - **Dependencies**: Task 40

42. **Implement DELETE /conversations/{id}**
    - Signature: `async def delete_conversation(conversation_id: str, user: dict = Depends(get_current_user))`
    - Get DB, instantiate service
    - Call `service.delete_conversation(UUID(conversation_id))`
    - Return: `{"success": True, "message": "Conversation deleted"}`
    - **Files**: `backend/src/api/routes/chat.py` (endpoint)
    - **Dependencies**: Task 41

43. **Register chat router in main.py**
    - Import: `from src.api.routes.chat import router as chat_router`
    - Register: `app.include_router(chat_router)`
    - **Files**: `backend/src/main.py`
    - **Dependencies**: Task 42

---

### Phase 6: Testing

**Goal**: Unit and integration tests for new components

**Tasks**:

44. **Create conversation fixtures**
    - File: `backend/tests/fixtures/conversation_fixtures.py`
    - Fixtures: `test_conversation`, `test_message`, `test_conversation_with_messages`
    - Follow pattern from `task_fixtures.py`
    - **Files**: `backend/tests/fixtures/conversation_fixtures.py`
    - **Dependencies**: Task 43

45. **Write ConversationService unit tests**
    - File: `backend/tests/unit/test_conversation_service.py`
    - Test: `test_create_conversation`, `test_get_conversation`, `test_list_conversations`
    - Test: `test_add_message`, `test_get_messages`, `test_delete_conversation`
    - Test: `test_unauthorized_access` (cross-user)
    - **Files**: `backend/tests/unit/test_conversation_service.py`
    - **Dependencies**: Task 44

46. **Write MCP tool unit tests**
    - File: `backend/tests/unit/test_mcp_tools.py`
    - Mock MCP context and DB session
    - Test each tool: `test_add_task_tool`, `test_list_tasks_tool`, etc.
    - Test error handling (task not found, validation errors)
    - **Files**: `backend/tests/unit/test_mcp_tools.py`
    - **Dependencies**: Task 45

47. **Write Master Agent unit tests**
    - File: `backend/tests/unit/test_master_agent.py`
    - Mock OpenAI client and MCP session
    - Test: `test_load_history`, `test_format_tools`, `test_execute_tools`
    - Test: `test_confirmation_workflow`
    - **Files**: `backend/tests/unit/test_master_agent.py`
    - **Dependencies**: Task 46

48. **Write end-to-end chat integration test**
    - File: `backend/tests/integration/test_chat_e2e.py`
    - Mock OpenAI API (use responses library or similar)
    - Test: `test_chat_create_task` (user message → agent → MCP → DB → response)
    - Test: `test_chat_with_history` (multi-turn conversation)
    - Test: `test_chat_confirmation_workflow` (delete with confirmation)
    - Test: `test_conversation_persistence` (messages saved to DB)
    - **Files**: `backend/tests/integration/test_chat_e2e.py`
    - **Dependencies**: Task 47

49. **Run all tests and verify**
    - Command: `pytest backend/tests -v --cov=backend/src`
    - Verify: 100% coverage for new services
    - Verify: No Phase II regressions (all old tests pass)
    - Fix any failures
    - **Files**: None (verification)
    - **Dependencies**: Task 48

---

### Phase 7: Documentation & Cleanup

**Goal**: Update docs, verify stateless design, final validation

**Tasks**:

50. **Update README or API docs**
    - Document new `/chat` endpoints
    - Document required environment variables (OPENAI_API_KEY)
    - Document MCP server usage
    - **Files**: `README.md` or `backend/docs/api.md`
    - **Dependencies**: Task 49

51. **Verify stateless design**
    - Manual test: Send chat request, restart server, send follow-up
    - Verify: Context loads from DB, no agent state persists
    - Verify: Agent instances discarded after each request
    - **Files**: None (verification)
    - **Dependencies**: Task 50

52. **Verify Phase II baseline unchanged**
    - Test: Phase II frontend still connects to CRUD endpoints
    - Test: Task CRUD operations work via REST API
    - Test: Auth flow unchanged
    - **Files**: None (verification)
    - **Dependencies**: Task 51

53. **Performance baseline**
    - Manual test: Measure chat endpoint P95 latency
    - Target: < 3s including OpenAI API call
    - Document results
    - **Files**: `specs/backend-ai-mcp/performance.md` (optional)
    - **Dependencies**: Task 52

54. **Final validation checklist**
    - ✅ All 5 MCP tools implemented and tested
    - ✅ Master Agent + 3 sub-agents working
    - ✅ Conversation/Message models in DB
    - ✅ ConversationService enforces user ownership
    - ✅ Chat endpoint stateless (loads context from DB)
    - ✅ Confirmation workflow functional
    - ✅ All tests passing (unit + integration)
    - ✅ No Phase II regressions
    - **Files**: None (checklist)
    - **Dependencies**: Task 53

---

## Task Dependency Graph

```
Phase 0: [1] → [2] → [3]
Phase 1: [3] → [4] → [5] → [6] → [7] → [8]
Phase 2: [8] → [9] → [10,16] → [11] → [12] → [13] → [14] → [15]
Phase 3: [16] → [17] → [18] → [19] → [20] → [21] → [22] → [23] → [24]
Phase 4: [24] → [25] → [26] → [27] → [28] → [29] → [30] → [31] → [32] → [33] → [34]
Phase 5: [34] → [35] → [36] → [37] → [38] → [39] → [40] → [41] → [42] → [43]
Phase 6: [43] → [44] → [45] → [46] → [47] → [48] → [49]
Phase 7: [49] → [50] → [51] → [52] → [53] → [54]
```

**Critical Path**: Tasks 1-3-8-16-24-34-43-49-54 (linear backbone)

**Parallelizable**: Tasks 10-16 (can run together), Tasks 19-23 (MCP tools), Tasks 45-47 (unit tests)

---

## Risk Mitigation

| Risk | Mitigation Strategy | Contingency |
|------|-------------------|-------------|
| **OpenAI API latency > 3s** | Set timeout (10s), use `gpt-4-turbo` for speed | Surface timeout error gracefully, retry once |
| **MCP stdio communication failure** | Add connection health check in `connect_mcp()` | Return 503 Service Unavailable to client |
| **Context window overflow (>20 msgs)** | Hard limit to last 20 messages in `_load_history()` | Implement summarization (future) |
| **Confirmation bypass vulnerability** | Enforce check in both agent and MCP tool | Audit logs for destructive operations |
| **Phase II regression** | Run full test suite before Phase III start | Rollback if any Phase II test fails |
| **Stateless violation (agent state leaks)** | Code review + manual testing (Task 51) | Refactor to DB-backed state if needed |

---

## Success Metrics

**Functional**:
- ✅ User sends "create a task called X" → task created in DB
- ✅ User sends "list my tasks" → tasks returned
- ✅ User sends "delete task Y" → confirmation prompt → user confirms → task deleted
- ✅ Multi-turn conversation persists (messages retrieved across requests)

**Non-Functional**:
- ✅ P95 latency < 3s (measured in Task 53)
- ✅ 100% test coverage for ConversationService, MCP tools, Master Agent
- ✅ Zero Phase II regressions (all old tests pass)
- ✅ Stateless design verified (Task 51)

**Constitution Compliance**:
- ✅ AI-First: Natural language interface via chat endpoint
- ✅ MCP-Driven: All operations via MCP tools
- ✅ Stateless: No agent state persists, DB-loaded context
- ✅ Sub-Agent Orchestration: Master → Task/Conversation/Confirmation
- ✅ Context Preservation: Conversation/Message in PostgreSQL
- ✅ Reusable Intelligence: TaskService unchanged

---

## Next Steps

1. Run `/sp.tasks` to generate detailed tasks.md from this plan
2. Execute tasks in dependency order (Phases 0-7)
3. Use `/sp.implement` to execute tasks programmatically
4. Commit after each phase with descriptive messages
5. Run full test suite after Phase 6
6. Document any deviations from plan in `specs/backend-ai-mcp/CHANGES.md`

---

**Plan Status**: ✅ Ready for Task Generation
**Estimated Complexity**: 54 tasks across 7 phases
**Execution Mode**: Sequential with parallelizable sub-tasks
